<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css"
    integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous"> -->
  <link rel="stylesheet" href="css/bootstrap.min.css">


  <title>Hello, world!</title>
</head>

<body>
  <!-- <h1>Hello, world!</h1> -->

  <div class="container">
    <div class="row">
      <div class="input-group mb-3">
        <input name="url" type="text" class="form-control" placeholder="url" aria-label="url"
          aria-describedby="button-addon2">
        <div class="input-group-append">
          <button class="btn btn-outline-secondary" type="button" id="button-addon2" onclick="play()">Play</button>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <div class="embed-responsive embed-responsive-16by9">
          <video class="embed-responsive-item" controls>
            <source name="video_source" src="" type="video/mp4">
          </video>
        </div>
      </div>
      <div class="col">
        <table class="table table-borderless">
          <tbody>
            <tr>
              <td name="speed">100kb/s</td>
              <td name="size">10M/100M</td>
              <td name="percent">20%</td>
            </tr>
          </tbody>
        </table>
        <ul class="list-group">
          <li class="list-group-item">
            <div class="progress">
              <div class="progress-bar bg-success" role="progressbar" style="width: 25%" aria-valuenow="25"
                aria-valuemin="0" aria-valuemax="100"></div>
              <div class="progress-bar" role="progressbar" style="width: 25%" aria-valuenow="25" aria-valuemin="0"
                aria-valuemax="100"></div>
              <div class="progress-bar bg-success" role="progressbar" style="width: 40%" aria-valuenow="30"
                aria-valuemin="0" aria-valuemax="100"></div>
              <div class="progress-bar bg-info" role="progressbar" style="width: 10%" aria-valuenow="20"
                aria-valuemin="0" aria-valuemax="100"></div>

            </div>
          </li>
          <li class="list-group-item">
            <div class="progress">
              <div class="progress-bar bg-info" role="progressbar" style="width: 50%" aria-valuenow="50"
                aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </li>
          <li class="list-group-item">
            <div class="progress">
              <div class="progress-bar bg-warning" role="progressbar" style="width: 75%" aria-valuenow="75"
                aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </li>
          <li class="list-group-item">
            <div class="progress">
              <div class="progress-bar bg-danger" role="progressbar" style="width: 100%" aria-valuenow="100"
                aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </li>
          <br>
          <p> hello </p>
        </ul>
      </div>
    </div>
    <div class="row">
      <div class="col" id="chart">

      </div>
    </div>
  </div>

  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <!-- <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script> -->



  <!-- <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"
    integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"
    integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script> -->

  <script src="js/jquery-3.1.1.min.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/apexcharts.js"></script>


  <script type="text/javascript">

    function humanFileSize(bytes, si) {
      var thresh = si ? 1000 : 1024;
      if (Math.abs(bytes) < thresh) {
        return bytes + ' B';
      }
      var units = si
        ? ['kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB']
        : ['KiB', 'MiB', 'GiB', 'TiB', 'PiB', 'EiB', 'ZiB', 'YiB'];
      var u = -1;
      do {
        bytes /= thresh;
        ++u;
      } while (Math.abs(bytes) >= thresh && u < units.length - 1);
      return bytes.toFixed(1) + ' ' + units[u];
    }

    var data = {
      speed: 1024 * 100,
      totalLength: 1024 * 1024 * 30,
      completedLength: 1024 * 1024,
      readers: [
        {
          pos: 1024 * 455
        }
      ],
      contents: [
        {
          pos: 1024,
          len: 1024
        }, {
          pos: 1024 * 3,
          len: 1024 * 30
        }
      ],
      pipes: [
        {
          name: "0x444555",
          pos: 1024 * 8,
          len: 1024 * 933
        }, {
          name: "0x444785",
          pos: 1024 * 44,
          len: 1024 * 74
        }
      ]
    };

    var map = {
      '0': [0, 0, 0, 0],
      '1': [0, 0, 0, 1],
      '2': [0, 0, 1, 0],
      '3': [0, 0, 1, 1],
      '4': [0, 1, 0, 0],
      '5': [0, 1, 0, 1],
      '6': [0, 1, 1, 0],
      '7': [0, 1, 1, 1],
      '8': [1, 0, 0, 0],
      '9': [1, 0, 0, 1],
      'A': [1, 0, 1, 0],
      'B': [1, 0, 1, 1],
      'C': [1, 1, 0, 0],
      'D': [1, 1, 0, 1],
      'E': [1, 1, 1, 0],
      'F': [1, 1, 1, 1]
    }

    function calculateSeries(bitmap) {
      var count = bitmap.length * 4;
      var column_count = 64;
      var row_count = Math.ceil(count / column_count);
      var i = 0;
      var char_index = 0;
      var series = [];
      while (i < row_count) {
        var char = bitmap[0];

        var items = [];
        while (char_index < column_count / 4 * (i + 1)) {
          if (char_index >= bitmap.length) {
            break;
          }
          var x = (i + 1).toString();
          var y = map[bitmap[char_index]];
          for (const yi in y) {
            items.push({
              x: x,
              y: (y[yi]) * 10 + 2
            });
          }

          char_index++;
        }
        series.push({ name: "", data: items });
        i++;
      }
      series.reverse();
      return series;
    }

    function calculateOptions(bitmap, unit) {
      var count = bitmap.length * 4;
      var column_count = 64;
      var row_count = Math.ceil(count / column_count);
      var series = calculateSeries(bitmap);

      // var i = 0;
      // var char_index = 0;
      // var series = [];
      // while (i < row_count) {
      //   var char = bitmap[0];

      //   var items = [];
      //   while (char_index < column_count / 4 * (i + 1)) {
      //     if (char_index >= bitmap.length) {
      //       break;
      //     }
      //     var x = (i + 1).toString();
      //     var y = map[bitmap[char_index]];
      //     for (const yi in y) {
      //       items.push({
      //         x: x,
      //         y: (y[yi]) * 10 + 2
      //       });
      //     }

      //     char_index++;
      //   }
      //   series.push({ name: "", data: items });
      //   i++;
      // }
      // series.reverse();
      return {
        chart: {
          height: row_count * 20,
          type: 'heatmap',
          animations: {
            enabled: false
          }
        },
        // plotOptions: {
        //   heatmap: {
        //     // shadeIntensity: 0.5,

        //     colorScale: {
        //       ranges: [{
        //         from: 0,
        //         to: 15,
        //         name: 'none',
        //         color: '#C0C0C0'
        //       },
        //       {
        //         from: 15,
        //         to: 25,
        //         name: 'data',
        //         color: '#128FD9'
        //       },
        //       ]
        //     }
        //   }
        // },
        colors: ["#008FFB"],
        dataLabels: {
          enabled: false
        },
        xaxis: {
          labels: {
            show: false
          },
          axisBorder: {
            show: false
          },
          axisTicks: {
            show: false
          },
        },
        series: series
      };
    }


    var rendered = false;
    var chart = new ApexCharts(
      document.querySelector("#chart"),
      calculateOptions("", 16 * 1024 * 1024)
    );

    function completedProgressDiv(data) {
      var progressDiv = ' \
        <div class="progress" > \
      <div class="progress-bar" role="progressbar" style="width: 15%" aria-valuenow="15" aria-valuemin="0" aria-valuemax="100"></div> \
      <div class="progress-bar bg-success" role="progressbar" style="width: 30%" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"></div> \
      <div class="progress-bar bg-info" role="progressbar" style="width: 20%" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100"></div> \
</div > \
      ';
      return progressDiv;
    }

    function singleProgressDiv(pos, len, filesize) {
      if (filesize == 0) {
        return '<div class="progress"> \
  <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div> \
</div>';
      }
      if (Math.floor(100 * pos / filesize) == 0) {
        var percent = 100 * len / filesize;
        if (len == 0) {
          percent = 100;
        }
        percent = Math.floor(percent);
        var div = '<div class="progress"> \
  <div class="progress-bar bg-primary" role="progressbar" style="width: ' + percent + '%" aria-valuenow="' + percent + '" aria-valuemin="0" aria-valuemax="100"></div> \
</div>';
        return div;
      }
      var pos_percent = Math.floor(100 * pos / filesize);
      var len_percent = Math.floor(100 * len / filesize)
      if (len_percent == 0) {
        len_percent = 100 - pos_percent;
      }
      var progressDiv = ' \
        <div class="progress" > \
      <div class="progress-bar bg-light" role="progressbar" style="width: ' + pos_percent +'%" aria-valuenow="' + pos_percent + '" aria-valuemin="0" aria-valuemax="100"></div> \
      <div class="progress-bar bg-primary" role="progressbar" style="width: ' + len_percent + '%" aria-valuenow="' + len_percent + '" aria-valuemin="0" aria-valuemax="100"></div> \
</div > \
      ';
      return progressDiv;
    }

    function updateProgress(data) {
      $("td[name='speed']").text(humanFileSize(data.speed) + '/s');
      $("td[name='size']").text(humanFileSize(data.completedLength) + '/' + humanFileSize(data.totalLength));
      $("td[name='percent']").text((data.completedLength / data.totalLength * 100).toFixed(1) + '%');

      var progress_div = ' \
      <ul class="list-group"> \
      ';

      progress_div += '<li class="list-group-item">';
      progress_div += singleProgressDiv(0, data.completedLength, data.totalLength);
      progress_div += '</li>'

      if (data.readers.length > 0) {
        progress_div += '<li class="list-group-item"> <p>readers</p>';
        
        var reader_div = "";
        for (let index = 0; index < data.readers.length; index++) {
          const element = data.readers[index];
          reader_div += singleProgressDiv(element.pos, element.len, data.totalLength);          
        }
        progress_div += reader_div;
        progress_div += '</li>'
      }

      if (data.pipes.length > 0) {
        progress_div += '<li class="list-group-item"> <p>pipes</p>';
        var pipe_div = "";
        for (let index = 0; index < data.pipes.length; index++) {
          const element = data.pipes[index];
          pipe_div += singleProgressDiv(element.pos, element.len, data.totalLength);          
        }
        progress_div += pipe_div;
        progress_div += '</li>'
      }

      progress_div += '</ul>';
      // console.log(progress_div);
      $('ul.list-group').replaceWith(progress_div);

      if (data.bitmap.length > 10) {
        if (!rendered) {
          chart = new ApexCharts(
            document.querySelector("#chart"),
            calculateOptions(data.bitmap, 16 * 1024 * 1024)
          );
          chart.render();
          rendered = true;
        } else {
          chart.updateSeries(calculateSeries(data.bitmap), false);
        }
      }
    }

    // updateProgress(data);


    function play() {
      var url = $("input[name='url']").val();
      url = encodeURIComponent(url)
      var v = '<video class="embed-responsive-item" controls> \
            <source name="video_source" \
              src="' + '/stream/test.mp4?url=' + url + '" \
              type="video/mp4"> \
          </video>'
      $("video.embed-responsive-item").replaceWith(v)
      // $("source[name='video_source']").attr("src", '/stream/test.mp4?url='+url);
    }

    function start_ws(id) {
      var ws = new WebSocket('ws://' + location.host + '/ws/monitor');
      ws.onopen = function (ev) {
        console.log(ev);
        ws.send(id);
      };
      ws.onerror = function (ev) { console.log(ev); };
      ws.onclose = function (ev) { console.log(ev); };
      ws.onmessage = function (ev) {
        console.log(ev);
      };
    }


    function start_refresh(id) {
      $.get('/api/tasks/' + id, function (result) {
        updateProgress(result);
      });
      setTimeout(() => {
        start_refresh(id);
      }, 1000);
    }

    var default_url = 'http://vfx.mtime.cn/Video/2019/02/13/mp4/190213103941602230.mp4';
    function load_task() {
      $.get('/api/tasks', function (result) {
        result.forEach(task => {
          if (task.url == default_url) {
            // start_ws(task.id);
            start_refresh(task.id)
          }
        });
      });
    }

    // url = 'stream/test.mp4?url' + 
    $("input[name='url']").val(default_url);
    play();

    setTimeout("load_task()", 1000)

  </script>



</body>

</html>